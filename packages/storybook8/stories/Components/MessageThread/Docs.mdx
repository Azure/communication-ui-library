import { Canvas, Description, Meta, Source, ArgTypes } from '@storybook/blocks';
import { SingleLineBetaBanner } from '../../BetaBanners/SingleLineBetaBanner';
import { DetailedBetaBanner } from '../../BetaBanners/DetailedBetaBanner';
import { MessageThread } from '@azure/communication-react';
import * as MessageThreadStories from './index.stories';

import MessageThreadWithBlockedMessagesExampleText from '!!raw-loader!./snippets/BlockedMessages.snippet.tsx';
import MessageThreadWithCustomAvatarExampleText from '!!raw-loader!./snippets/CustomAvatar.snippet.tsx';
import MessageThreadWithCustomBlockedMessageContainerExampleText from '!!raw-loader!./snippets/CustomBlockedMessage.snippet.tsx';
import MessageThreadWithCustomChatContainerExampleText from '!!raw-loader!./snippets/CustomChatContainer.snippet.tsx';
import MessageThreadWithCustomMessageContainerExampleText from '!!raw-loader!./snippets/CustomMessageContainer.snippet.tsx';
import MessageThreadWithCustomMessagesExampleText from '!!raw-loader!./snippets/CustomMessages.snippet.tsx';
import MessageThreadWithCustomMessageStatusIndicatorExampleText from '!!raw-loader!./snippets/CustomMessageStatusIndicator.snippet.tsx';
import MessageThreadWithCustomTimestampExampleText from '!!raw-loader!./snippets/CustomTimestamp.snippet.tsx';
import DefaultMessageThreadExampleText from '!!raw-loader!./snippets/Default.snippet.tsx';
import MessageThreadWithMessageStatusIndicatorExampleText from '!!raw-loader!./snippets/MessageStatusIndicator.snippet.tsx';
import MessageWithAttachmentText from '!!raw-loader!./snippets/MessageWithAttachment.snippet.tsx';
import MessageWithAttachmentFromTeamsText from '!!raw-loader!./snippets/MessageWithAttachmentFromTeams.snippet.tsx';
import MessageWithCustomAttachmentText from '!!raw-loader!./snippets/MessageWithCustomAttachment.snippet.tsx';
import MessageWithCustomMentionRendererText from '!!raw-loader!./snippets/MessageWithCustomMentionRenderer.snippet.tsx';
import ExampleImportantsText from '!!raw-loader!./snippets/placeholdermessages.ts';
import MessageThreadWithSystemMessagesExampleText from '!!raw-loader!./snippets/SystemMessages.snippet.tsx';
import MessageThreadWithInlineImageExampleText from '!!raw-loader!./snippets/WithInlineImageMessage.snippet.tsx';
import MessageThreadWithMessageDateExampleText from '!!raw-loader!./snippets/WithMessageDate.snippet.tsx';
import MessageThreadWithRichTextEditorExampleText from '!!raw-loader!./snippets/WithRichTextEditor.snippet.tsx';
import MessageThreadWithRichTextEditorInlineImagesExampleText from '!!raw-loader!./snippets/WithRichTextEditorInlineImages.snippet.tsx';
import MessageThreadWithRichTextEditorOnPasteExampleText from '!!raw-loader!./snippets/WithRichTextEditorOnPaste.snippet.tsx';

<Meta of={MessageThreadStories} />

# MessageThread

MessageThread allows you to easily create a component for rendering chat messages, handling scrolling behavior of new/old messages and customizing icons & controls inside the chat thread.

MessageThread internally uses the `Chat` & `ChatMessage` components from `@fluentui-contrib/chat`. You can
checkout the details about these components
[here](https://microsoft.github.io/fluentui-contrib/react-chat/?path=/story/chat--default).

The MessageThread component supports lazy loading for the rich text editor used for editing messages. This means
that the rich text editor and its dependencies can be excluded from the bundle if they're not required,
utilizing tree-shaking techniques such as [the sideEffects
option](https://webpack.js.org/guides/tree-shaking/#mark-the-file-as-side-effect-free) in webpack.

## Importing

```ts
import { FluentThemeProvider, MessageThread } from '@azure/communication-react';
```

## Sample messages

Create a `placeholdermessages.ts` file in the current folder you are working on. Then copy paste the code below
into that file.

<Source code={ExampleImportantsText} />

## Default MessageThread

By default, MessageThread displays Chat messages with display name of only for other users and creation time
of message when available.

<Canvas of={MessageThreadStories.DefaultMessageThreadDocsOnly} source={{ code: DefaultMessageThreadExampleText }} />

## MessageThread With Message Date

<Canvas of={MessageThreadStories.DateExampleDocsOnly} source={{ code: MessageThreadWithMessageDateExampleText }} />

## System Message

The example below shows a message thread with a system message.

<Canvas of={MessageThreadStories.SystemMessageDocsOnly} source={{ code: MessageThreadWithSystemMessagesExampleText }} />

## Blocked Message

<SingleLineBetaBanner />

The example below shows a message thread with a blocked message. If `link` is not provided, it will omit the hyperlink.

<Canvas
  of={MessageThreadStories.BlockedMessagesDocsOnly}
  source={{ code: MessageThreadWithBlockedMessagesExampleText }}
/>

## Custom Message

he example below shows how to render a `custom` message with `onRenderMessage` in `MessageThread`

<Canvas
  of={MessageThreadStories.CustomMessagesDocsOnly}
  source={{ code: MessageThreadWithCustomMessagesExampleText }}
/>

## Messages with Customized Chat Container

The example below shows how to render a `custom` chat container with `styles.chatContainer` in `MessageThread`

<Canvas
  of={MessageThreadStories.CustomChatContainerDocsOnly}
  source={{ code: MessageThreadWithCustomChatContainerExampleText }}
/>

## Messages with Customized Message Container

The example below shows how to render a `custom` message container with `styles.chatMessageContainer` or
`styles.systemMessageContainer` in `MessageThread`

Note: In the code example, all `%` characters were replaced by their unicode value `\u0025` due to URI
malformed issue when loading the storybook snippets

<Canvas
  of={MessageThreadStories.CustomMessageContainerDocsOnly}
  source={{ code: MessageThreadWithCustomMessageContainerExampleText }}
/>

## Messages with Customized Blocked message Container

<SingleLineBetaBanner />

The example below shows how to render a `blocked` message with custom `warningText`, with
`styles.blockedMessageContainer` for styling, and rendering your own JSX.Element with with `onRenderMessage`
in `MessageThread`

<Canvas
  of={MessageThreadStories.CustomBlockedMessageDocsOnly}
  source={{ code: MessageThreadWithCustomBlockedMessageContainerExampleText }}
/>

## Default Message Status Indicator

<Canvas
  of={MessageThreadStories.MessageStatusIndicatorDocsOnly}
  source={{ code: MessageThreadWithMessageStatusIndicatorExampleText }}
/>

## Custom Message Status Indicator

The example below shows how to render a `custom` message status indicator with `onRenderMessageStatus` in
`MessageThread`

<Canvas
  of={MessageThreadStories.CustomStatusIndicatorDocsOnly}
  source={{ code: MessageThreadWithCustomMessageStatusIndicatorExampleText }}
/>

## Custom Avatar

<Canvas of={MessageThreadStories.CustomAvatarDocsOnly} source={{ code: MessageThreadWithCustomAvatarExampleText }} />

Note: You can view the details of the
[Persona](https://developer.microsoft.com/fluentui#/controls/web/persona) component

## Custom Timestamp

<SingleLineBetaBanner />
<Canvas
  of={MessageThreadStories.CustomTimestampExampleDocsOnly}
  source={{ code: MessageThreadWithCustomTimestampExampleText }}
/>

## Tapping Inline Images on Messages

<Canvas of={MessageThreadStories.InlineImageDocsOnly} source={{ code: MessageThreadWithInlineImageExampleText }} />

## Display Messages with Attachments

### Basic Usage: Default Attachment Rendering

The MessageThread component renders message attachments without any additional configuration. Simply provide a
list of `ChatMessages` with attachments of type `AttachmentMetadata` and the component will render the message
content along with associated attachments.

By default, the button associated with the attachment card will open the attachment in a new tab.
Specifically, `window.open` method will be called for target `URL` defined in `AttachmentMetadata`.

<Canvas of={MessageThreadStories.AttachmentsDocsOnly} source={{ code: MessageWithAttachmentText }} />

If the identity of message sender is a Microsoft Teams user, the attachment will be rendered with an `open`
icon shown below.

<Canvas of={MessageThreadStories.AttachmentFromTeamsDocsOnly} source={{ code: MessageWithAttachmentFromTeamsText }} />

### Advanced Usage: Customizing Attachment Rendering

<DetailedBetaBanner />

The MessageThread component also supports multiple ways to customize the rendering. You can leverage the
`attachmentOptions.downloadOptions` props to provide a dynamic list of menu action buttons that will be based
on properties of the attachment or the chat message associated with it. Moreover, you can also opt to provide
a static list for all scenarios.

For example, the following code snippet demonstrates how to customize the download options for attachments.

<Canvas of={MessageThreadStories.CustomAttachmentsDocsOnly} source={{ code: MessageWithCustomAttachmentText }} />

## Mention of Users with a custom renderer within Message

<SingleLineBetaBanner version={'1.7.0-beta.1'} />

When a user is mentioned in a message, a custom HTML tag is used to represent the element in the
MessageThread. This element can be styled using the standard methods and the renderer can be overridden for
further customization. The HTML Tag is defined:

```ts
<msft-mention id="<id>">Displayable Text</msft-mention>
```

The MessageThread component also supports mentioning users when editing a message if the `lookupOptions` under the `mentionOptions` property is provided. However, if the `richTextEditorOptions` property is set, the `lookupOptions` will be ignored.

<Canvas of={MessageThreadStories.CustomMentionsDocsOnly} source={{ code: MessageWithCustomMentionRendererText }} />

## Rich Text Editor Support for Editing Messages

<SingleLineBetaBanner />

The following examples show how to enable rich text editor for message editing by providing the `richTextEditorOptions` property. Rich text editor does not support mentioning users at the moment. By setting `richTextEditorOptions` property, the `lookupOptions` under the `mentionOptions` property will be ignored.

Enabling the rich text editor for message editing, without customizing its behavior, can be achieved by setting the richTextEditorOptions.

<Canvas
  of={MessageThreadStories.RichTextEditorTextDocsOnly}
  source={{ code: MessageThreadWithRichTextEditorExampleText }}
/>

## Rich Text Editor Support for Editing Messages with Inline Images

<SingleLineBetaBanner />

The following examples show how to enable image insert functionality for message editing with rich text
editor. Under the `richTextEditorOptions` prop, the `onInsertInlineImage` callback is used to handle each
inline image that is inserted into the editor. When not provided, pasting images into the rich text editor
will be disabled. This callback can be used to manipulate the imageAttributes src URL (which is a local blob
URL), and implement any other custom logic. After processing each inserted image in the callback, the results
should be passed back to the component through the `messagesInlineImagesWithProgress` prop. This prop will be
used to render the error bar to the end user. Note that for the error of content exceeds the maximum length,
the `id` and `url` props provided in the `inlineImagesWithProgress` will be used in the calculation to achieve
a more accurate result. The content provided in the `onSendMessage` does not contain any information from the
`inlineImagesWithProgress`. To add or replace image attributes, manually parse the HTML content and update the
image attributes. After an inline image is removed from the editor, the `onRemoveInlineImage` callback will be
triggered. At this point, the image is already removed from the UI and the local blob of the image has already
been revoked. This callback can be used to implement custom logic such as deleting the image from the server.
When the inline images are displayed in the message thread, we restrict the max-width on each image, but not
the height. Long images will take up vertical space in the message thread. Also, when inserting images between
text, images will be on the same line as the text. If you wish to change this behavior so that each image is
always on a new line, you can set the display property to block for all image tags. For certain Android
devices, pasting of a single image is only supported by long pressing on the rich text editor and choosing
paste. Selecting from the clipboard view from keyboard may not be supported.

<Canvas
  of={MessageThreadStories.RichTextEditorInlineImagesTextDocsOnly}
  source={{ code: MessageThreadWithRichTextEditorInlineImagesExampleText }}
/>

## Process content on paste in Rich Text Editor during message editing

<SingleLineBetaBanner />

`richTextEditorOptions` provides `onPaste` callback for custom processing of the pasted content before it's inserted into the rich text editor for message editing. This callback can be used to implement custom paste handling logic tailored to your application's needs. The example below shows how to remove images from pasted content.

<Canvas
  of={MessageThreadStories.RichTextEditorOnPasteTextDocsOnly}
  source={{ code: MessageThreadWithRichTextEditorOnPasteExampleText }}
/>

## Props

<ArgTypes of={MessageThread} />
