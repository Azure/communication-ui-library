# Components browser tests

This folder contains some Playwright browser tests for the components. See the [top-level testing documentation](../../../docs/references/automated-tests.md) to understand how these tests fit into our overall testing strategy.

## Folder structure
* [../playwright.config.components.ts](../playwright.config.components.ts) Configuration for components tests
* [../playwright](../playwright) - Files needed for Playwright component testing
    * [../playwright/.cache](../playwright/.cache) - Vite cache
* [../tests](../tests) - Top folder for snapshot tests, snapshots and tests output
    * [../tests/browser](../tests/browser) - Components tests
    * [../tests/snapshots](../tests/snapshots) - Snapshots for the beta and stable flavors
    * [../tests/temp](../tests/temp) - Tests output (including the diff for failed tests)

## Run tests

In `packages/react-components`, run

```sh
rushx test:components
```
The tests will be run for the current flavor.

## Update snapshots

Snapshots must only be updated as part of the CI pipeline. This is because the build agents may run on a different OS and have different graphics setup that your local machine (so there will be slight pixel differences between locally generated snapshots and ones generated by the CI pipeline).

To update snapshots,

- Add the `update_snapshots` label to your PR.
- The [update-snapshots.yml](https://github.com/Azure/communication-ui-library/actions/workflows/update-snapshots.yml) GitHub action will generate new snapshots and push commit to your branch.
  - The workflow will remove the `update_snapshots` label from your PR. If you need to update snapshots again, you must add the label once again.

### Manual updates

As mentioned above, you should not need to update snapshots manually. This section describes the tooling available for snapshot update. This tooling is also used by the GitHub action mentioned above.

The CI job uses 
```sh
rushx test:components:update
```
script to update the snapshots.

## Test development

The components tests are lightweight and use less resources comparing with the usual Playwright tests.
- A file with extension `.spec.tsx` should be created for new components tests.
- `component.evaluate(() => document.fonts.ready);` should be called after the component is mounted to check that all fonts are loaded and get more stable results for snapshots.
- Be sure to check that components are show as expected with `expect` or `waitFor` before checking the snapshots. This is because Playwright components tests are super fast and tests may be flaky because of this.


### Conditional Compilation

Just like the rest of the UI library code, the components test use babel plugin to process the code. But the tests themselves can't use conditional compilation flags to be processed and need to use skip and fixtures feature in Playwright to be run for different flavors.

The fixture flag is already added to the Playwright configuration file and `FlavoredBaseTest.tsx` to be reused during future development.

In order to use the functionality, you will need:
- import `test` from `FlavoredBaseTest.tsx`
```Typescript
import { test as betaTest } from './FlavoredBaseTest';
```
- add a separate `describe` block and use skip function inside it before any beta tests (there may be a few descibe block for different beta functionality)

```Typescript

//This is an example of a description with a eta only test
betaTest.describe('TypingIndicator beta only test', () => {
  betaTest.skip(({ isBetaBuild }) => !isBetaBuild, 'The tests should be run for beta flavor only');

  betaTest('TypingIndicator should be shown correctly 123', async ({ mount }) => {
    // some test
  });
});
```

### Local debugging and UI mode

Run `rushx test:components --debug` command in Terminal from the `packages/react-components` folder to debug tests locally. 
Run `rushx test:components --ui` command in Terminal from the `packages/react-components` folder to run tests in UI mode.
In debug mode the script runs the test under [Playwright Inspector](https://playwright.dev/docs/debug). Additionally, some internal test timeouts are relaxed to allow you to single-step through the tests via the inspector.

This mode requires a display device because the tests need to run in a browser with a display. In particular, this means that you can not use this mode on GitHub Codespaces.

To debug a particular test,

* Select the test to run via [`test.only`](https://playwright.dev/docs/api/class-test#test-only)
  ```typescript
  test.describe('describe example', () => {
    test.only('test example', async () => {
      ...
  ```
* Run the relevant test suite, usually selecting a single project: `rushx test:components --debug`
* Single-step through the test, record a video etc through the Inspector.

