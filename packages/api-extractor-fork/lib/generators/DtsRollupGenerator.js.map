{"version":3,"file":"DtsRollupGenerator.js","sourceRoot":"","sources":["../../src/generators/DtsRollupGenerator.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\n/* eslint-disable no-bitwise */\r\n\r\nimport * as ts from 'typescript';\r\nimport { FileSystem, NewlineKind, InternalError } from '@rushstack/node-core-library';\r\nimport { ReleaseTag } from '@microsoft/api-extractor-model';\r\n\r\nimport { Collector } from '../collector/Collector';\r\nimport { TypeScriptHelpers } from '../analyzer/TypeScriptHelpers';\r\nimport { Span, SpanModification } from '../analyzer/Span';\r\nimport { AstImport } from '../analyzer/AstImport';\r\nimport { CollectorEntity } from '../collector/CollectorEntity';\r\nimport { AstDeclaration } from '../analyzer/AstDeclaration';\r\nimport { ApiItemMetadata } from '../collector/ApiItemMetadata';\r\nimport { AstSymbol } from '../analyzer/AstSymbol';\r\nimport { SymbolMetadata } from '../collector/SymbolMetadata';\r\nimport { StringWriter } from './StringWriter';\r\nimport { DtsEmitHelpers } from './DtsEmitHelpers';\r\nimport { DeclarationMetadata } from '../collector/DeclarationMetadata';\r\n\r\n/**\r\n * Used with DtsRollupGenerator.writeTypingsFile()\r\n */\r\nexport enum DtsRollupKind {\r\n  /**\r\n   * Generate a *.d.ts file for an internal release, or for the trimming=false mode.\r\n   * This output file will contain all definitions that are reachable from the entry point.\r\n   */\r\n  InternalRelease,\r\n\r\n  /**\r\n   * Generate a *.d.ts file for a preview release.\r\n   * This output file will contain all definitions that are reachable from the entry point,\r\n   * except definitions marked as \\@alpha or \\@internal.\r\n   */\r\n  BetaRelease,\r\n\r\n  /**\r\n   * Generate a *.d.ts file for a public release.\r\n   * This output file will contain all definitions that are reachable from the entry point,\r\n   * except definitions marked as \\@beta, \\@alpha, or \\@internal.\r\n   */\r\n  PublicRelease\r\n}\r\n\r\nexport class DtsRollupGenerator {\r\n  /**\r\n   * Generates the typings file and writes it to disk.\r\n   *\r\n   * @param dtsFilename    - The *.d.ts output filename\r\n   */\r\n  public static writeTypingsFile(\r\n    collector: Collector,\r\n    dtsFilename: string,\r\n    dtsKind: DtsRollupKind,\r\n    newlineKind: NewlineKind\r\n  ): void {\r\n    const stringWriter: StringWriter = new StringWriter();\r\n\r\n    DtsRollupGenerator._generateTypingsFileContent(collector, stringWriter, dtsKind);\r\n\r\n    FileSystem.writeFile(dtsFilename, stringWriter.toString(), {\r\n      convertLineEndings: newlineKind,\r\n      ensureFolderExists: true\r\n    });\r\n  }\r\n\r\n  private static _generateTypingsFileContent(\r\n    collector: Collector,\r\n    stringWriter: StringWriter,\r\n    dtsKind: DtsRollupKind\r\n  ): void {\r\n    if (collector.workingPackage.tsdocParserContext) {\r\n      stringWriter.writeLine(collector.workingPackage.tsdocParserContext.sourceRange.toString());\r\n      stringWriter.writeLine();\r\n    }\r\n\r\n    // Emit the triple slash directives\r\n    for (const typeDirectiveReference of collector.dtsTypeReferenceDirectives) {\r\n      // https://github.com/microsoft/TypeScript/blob/611ebc7aadd7a44a4c0447698bfda9222a78cb66/src/compiler/declarationEmitter.ts#L162\r\n      stringWriter.writeLine(`/// <reference types=\"${typeDirectiveReference}\" />`);\r\n    }\r\n\r\n    for (const libDirectiveReference of collector.dtsLibReferenceDirectives) {\r\n      stringWriter.writeLine(`/// <reference lib=\"${libDirectiveReference}\" />`);\r\n    }\r\n\r\n    // Emit the imports\r\n    for (const entity of collector.entities) {\r\n      if (entity.astEntity instanceof AstImport) {\r\n        const astImport: AstImport = entity.astEntity;\r\n\r\n        // For example, if the imported API comes from an external package that supports AEDoc,\r\n        // and it was marked as `@internal`, then don't emit it.\r\n        const symbolMetadata: SymbolMetadata | undefined = collector.tryFetchMetadataForAstEntity(astImport);\r\n        const maxEffectiveReleaseTag: ReleaseTag = symbolMetadata\r\n          ? symbolMetadata.maxEffectiveReleaseTag\r\n          : ReleaseTag.None;\r\n\r\n        if (this._shouldIncludeReleaseTag(maxEffectiveReleaseTag, dtsKind)) {\r\n          DtsEmitHelpers.emitImport(stringWriter, entity, astImport);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Emit the regular declarations\r\n    for (const entity of collector.entities) {\r\n      const symbolMetadata: SymbolMetadata | undefined = collector.tryFetchMetadataForAstEntity(\r\n        entity.astEntity\r\n      );\r\n      const maxEffectiveReleaseTag: ReleaseTag = symbolMetadata\r\n        ? symbolMetadata.maxEffectiveReleaseTag\r\n        : ReleaseTag.None;\r\n\r\n      if (!this._shouldIncludeReleaseTag(maxEffectiveReleaseTag, dtsKind)) {\r\n        if (!collector.extractorConfig.omitTrimmingComments) {\r\n          stringWriter.writeLine();\r\n          stringWriter.writeLine(`/* Excluded from this release type: ${entity.nameForEmit} */`);\r\n        }\r\n        continue;\r\n      }\r\n\r\n      if (entity.astEntity instanceof AstSymbol) {\r\n        // Emit all the declarations for this entry\r\n        for (const astDeclaration of entity.astEntity.astDeclarations || []) {\r\n          const apiItemMetadata: ApiItemMetadata = collector.fetchApiItemMetadata(astDeclaration);\r\n\r\n          if (!this._shouldIncludeReleaseTag(apiItemMetadata.effectiveReleaseTag, dtsKind)) {\r\n            if (!collector.extractorConfig.omitTrimmingComments) {\r\n              stringWriter.writeLine();\r\n              stringWriter.writeLine(\r\n                `/* Excluded declaration from this release type: ${entity.nameForEmit} */`\r\n              );\r\n            }\r\n            continue;\r\n          } else {\r\n            const span: Span = new Span(astDeclaration.declaration);\r\n            DtsRollupGenerator._modifySpan(collector, span, entity, astDeclaration, dtsKind);\r\n            stringWriter.writeLine();\r\n            stringWriter.writeLine(span.getModifiedText());\r\n          }\r\n        }\r\n      }\r\n\r\n      if (!entity.shouldInlineExport) {\r\n        for (const exportName of entity.exportNames) {\r\n          DtsEmitHelpers.emitNamedExport(stringWriter, exportName, entity);\r\n        }\r\n      }\r\n    }\r\n\r\n    DtsEmitHelpers.emitStarExports(stringWriter, collector);\r\n\r\n    // Emit \"export { }\" which is a special directive that prevents consumers from importing declarations\r\n    // that don't have an explicit \"export\" modifier.\r\n    stringWriter.writeLine();\r\n    stringWriter.writeLine('export { }');\r\n  }\r\n\r\n  /**\r\n   * Before writing out a declaration, _modifySpan() applies various fixups to make it nice.\r\n   */\r\n  private static _modifySpan(\r\n    collector: Collector,\r\n    span: Span,\r\n    entity: CollectorEntity,\r\n    astDeclaration: AstDeclaration,\r\n    dtsKind: DtsRollupKind\r\n  ): void {\r\n    const previousSpan: Span | undefined = span.previousSibling;\r\n\r\n    let recurseChildren: boolean = true;\r\n    switch (span.kind) {\r\n      case ts.SyntaxKind.JSDocComment:\r\n        // If the @packageDocumentation comment seems to be attached to one of the regular API items,\r\n        // omit it.  It gets explictly emitted at the top of the file.\r\n        if (span.node.getText().match(/(?:\\s|\\*)@packageDocumentation(?:\\s|\\*)/gi)) {\r\n          span.modification.skipAll();\r\n        }\r\n\r\n        // For now, we don't transform JSDoc comment nodes at all\r\n        recurseChildren = false;\r\n        break;\r\n\r\n      case ts.SyntaxKind.ExportKeyword:\r\n      case ts.SyntaxKind.DefaultKeyword:\r\n      case ts.SyntaxKind.DeclareKeyword:\r\n        // Delete any explicit \"export\" or \"declare\" keywords -- we will re-add them below\r\n        span.modification.skipAll();\r\n        break;\r\n\r\n      case ts.SyntaxKind.InterfaceKeyword:\r\n      case ts.SyntaxKind.ClassKeyword:\r\n      case ts.SyntaxKind.EnumKeyword:\r\n      case ts.SyntaxKind.NamespaceKeyword:\r\n      case ts.SyntaxKind.ModuleKeyword:\r\n      case ts.SyntaxKind.TypeKeyword:\r\n      case ts.SyntaxKind.FunctionKeyword:\r\n        // Replace the stuff we possibly deleted above\r\n        let replacedModifiers: string = '';\r\n\r\n        // Add a declare statement for root declarations (but not for nested declarations)\r\n        if (!astDeclaration.parent) {\r\n          replacedModifiers += 'declare ';\r\n        }\r\n\r\n        if (entity.shouldInlineExport) {\r\n          replacedModifiers = 'export ' + replacedModifiers;\r\n        }\r\n\r\n        if (previousSpan && previousSpan.kind === ts.SyntaxKind.SyntaxList) {\r\n          // If there is a previous span of type SyntaxList, then apply it before any other modifiers\r\n          // (e.g. \"abstract\") that appear there.\r\n          previousSpan.modification.prefix = replacedModifiers + previousSpan.modification.prefix;\r\n        } else {\r\n          // Otherwise just stick it in front of this span\r\n          span.modification.prefix = replacedModifiers + span.modification.prefix;\r\n        }\r\n        break;\r\n\r\n      case ts.SyntaxKind.VariableDeclaration:\r\n        // Is this a top-level variable declaration?\r\n        // (The logic below does not apply to variable declarations that are part of an explicit \"namespace\" block,\r\n        // since the compiler prefers not to emit \"declare\" or \"export\" keywords for those declarations.)\r\n        if (!span.parent) {\r\n          // The VariableDeclaration node is part of a VariableDeclarationList, however\r\n          // the Entry.followedSymbol points to the VariableDeclaration part because\r\n          // multiple definitions might share the same VariableDeclarationList.\r\n          //\r\n          // Since we are emitting a separate declaration for each one, we need to look upwards\r\n          // in the ts.Node tree and write a copy of the enclosing VariableDeclarationList\r\n          // content (e.g. \"var\" from \"var x=1, y=2\").\r\n          const list: ts.VariableDeclarationList | undefined = TypeScriptHelpers.matchAncestor(span.node, [\r\n            ts.SyntaxKind.VariableDeclarationList,\r\n            ts.SyntaxKind.VariableDeclaration\r\n          ]);\r\n          if (!list) {\r\n            // This should not happen unless the compiler API changes somehow\r\n            throw new InternalError('Unsupported variable declaration');\r\n          }\r\n          const listPrefix: string = list\r\n            .getSourceFile()\r\n            .text.substring(list.getStart(), list.declarations[0].getStart());\r\n          span.modification.prefix = 'declare ' + listPrefix + span.modification.prefix;\r\n          span.modification.suffix = ';';\r\n\r\n          if (entity.shouldInlineExport) {\r\n            span.modification.prefix = 'export ' + span.modification.prefix;\r\n          }\r\n\r\n          const declarationMetadata: DeclarationMetadata = collector.fetchDeclarationMetadata(astDeclaration);\r\n          if (declarationMetadata.tsdocParserContext) {\r\n            // Typically the comment for a variable declaration is attached to the outer variable statement\r\n            // (which may possibly contain multiple variable declarations), so it's not part of the Span.\r\n            // Instead we need to manually inject it.\r\n            let originalComment: string = declarationMetadata.tsdocParserContext.sourceRange.toString();\r\n            if (!/\\r?\\n\\s*$/.test(originalComment)) {\r\n              originalComment += '\\n';\r\n            }\r\n            span.modification.prefix = originalComment + span.modification.prefix;\r\n          }\r\n        }\r\n        break;\r\n\r\n      case ts.SyntaxKind.Identifier:\r\n        {\r\n          const referencedEntity: CollectorEntity | undefined = collector.tryGetEntityForNode(\r\n            span.node as ts.Identifier\r\n          );\r\n\r\n          if (referencedEntity) {\r\n            if (!referencedEntity.nameForEmit) {\r\n              // This should never happen\r\n              throw new InternalError('referencedEntry.nameForEmit is undefined');\r\n            }\r\n\r\n            span.modification.prefix = referencedEntity.nameForEmit;\r\n            // For debugging:\r\n            // span.modification.prefix += '/*R=FIX*/';\r\n          } else {\r\n            // For debugging:\r\n            // span.modification.prefix += '/*R=KEEP*/';\r\n          }\r\n        }\r\n        break;\r\n\r\n      case ts.SyntaxKind.ImportType:\r\n        DtsEmitHelpers.modifyImportTypeSpan(\r\n          collector,\r\n          span,\r\n          astDeclaration,\r\n          (childSpan, childAstDeclaration) => {\r\n            DtsRollupGenerator._modifySpan(collector, childSpan, entity, childAstDeclaration, dtsKind);\r\n          }\r\n        );\r\n        break;\r\n    }\r\n\r\n    if (recurseChildren) {\r\n      for (const child of span.children) {\r\n        let childAstDeclaration: AstDeclaration = astDeclaration;\r\n\r\n        // Should we trim this node?\r\n        let trimmed: boolean = false;\r\n        if (AstDeclaration.isSupportedSyntaxKind(child.kind)) {\r\n          childAstDeclaration = collector.astSymbolTable.getChildAstDeclarationByNode(\r\n            child.node,\r\n            astDeclaration\r\n          );\r\n          const releaseTag: ReleaseTag =\r\n            collector.fetchApiItemMetadata(childAstDeclaration).effectiveReleaseTag;\r\n\r\n          if (!this._shouldIncludeReleaseTag(releaseTag, dtsKind)) {\r\n            let nodeToTrim: Span = child;\r\n\r\n            // If we are trimming a variable statement, then we need to trim the outer VariableDeclarationList\r\n            // as well.\r\n            if (child.kind === ts.SyntaxKind.VariableDeclaration) {\r\n              const variableStatement: Span | undefined = child.findFirstParent(\r\n                ts.SyntaxKind.VariableStatement\r\n              );\r\n              if (variableStatement !== undefined) {\r\n                nodeToTrim = variableStatement;\r\n              }\r\n            }\r\n\r\n            const modification: SpanModification = nodeToTrim.modification;\r\n\r\n            // Yes, trim it and stop here\r\n            const name: string = childAstDeclaration.astSymbol.localName;\r\n            modification.omitChildren = true;\r\n\r\n            if (!collector.extractorConfig.omitTrimmingComments) {\r\n              modification.prefix = `/* Excluded from this release type: ${name} */`;\r\n            } else {\r\n              modification.prefix = '';\r\n            }\r\n            modification.suffix = '';\r\n\r\n            if (nodeToTrim.children.length > 0) {\r\n              // If there are grandchildren, then keep the last grandchild's separator,\r\n              // since it often has useful whitespace\r\n              modification.suffix = nodeToTrim.children[nodeToTrim.children.length - 1].separator;\r\n            }\r\n\r\n            if (nodeToTrim.nextSibling) {\r\n              // If the thing we are trimming is followed by a comma, then trim the comma also.\r\n              // An example would be an enum member.\r\n              if (nodeToTrim.nextSibling.kind === ts.SyntaxKind.CommaToken) {\r\n                // Keep its separator since it often has useful whitespace\r\n                modification.suffix += nodeToTrim.nextSibling.separator;\r\n                nodeToTrim.nextSibling.modification.skipAll();\r\n              }\r\n            }\r\n\r\n            trimmed = true;\r\n          }\r\n        }\r\n\r\n        if (!trimmed) {\r\n          DtsRollupGenerator._modifySpan(collector, child, entity, childAstDeclaration, dtsKind);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private static _shouldIncludeReleaseTag(releaseTag: ReleaseTag, dtsKind: DtsRollupKind): boolean {\r\n    switch (dtsKind) {\r\n      case DtsRollupKind.InternalRelease:\r\n        return true;\r\n      case DtsRollupKind.BetaRelease:\r\n        // NOTE: If the release tag is \"None\", then we don't have enough information to trim it\r\n        return (\r\n          releaseTag === ReleaseTag.Beta || releaseTag === ReleaseTag.Public || releaseTag === ReleaseTag.None\r\n        );\r\n      case DtsRollupKind.PublicRelease:\r\n        return releaseTag === ReleaseTag.Public || releaseTag === ReleaseTag.None;\r\n    }\r\n\r\n    throw new Error(`${DtsRollupKind[dtsKind]} is not implemented`);\r\n  }\r\n}\r\n"]}