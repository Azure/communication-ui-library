{"version":3,"file":"RunAction.js","sourceRoot":"","sources":["../../src/cli/RunAction.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport colors from 'colors';\r\nimport * as os from 'os';\r\nimport * as path from 'path';\r\nimport { PackageJsonLookup, FileSystem, IPackageJson, Path } from '@rushstack/node-core-library';\r\n\r\nimport {\r\n  CommandLineAction,\r\n  CommandLineStringParameter,\r\n  CommandLineFlagParameter\r\n} from '@rushstack/ts-command-line';\r\n\r\nimport { Extractor, ExtractorResult } from '../api/Extractor';\r\n\r\nimport { ApiExtractorCommandLine } from './ApiExtractorCommandLine';\r\nimport { ExtractorConfig, IExtractorConfigPrepareOptions } from '../api/ExtractorConfig';\r\n\r\nexport class RunAction extends CommandLineAction {\r\n  private _configFileParameter!: CommandLineStringParameter;\r\n  private _localParameter!: CommandLineFlagParameter;\r\n  private _verboseParameter!: CommandLineFlagParameter;\r\n  private _diagnosticsParameter!: CommandLineFlagParameter;\r\n  private _typescriptCompilerFolder!: CommandLineStringParameter;\r\n\r\n  public constructor(parser: ApiExtractorCommandLine) {\r\n    super({\r\n      actionName: 'run',\r\n      summary: 'Invoke API Extractor on a project',\r\n      documentation: 'Invoke API Extractor on a project'\r\n    });\r\n  }\r\n\r\n  protected onDefineParameters(): void {\r\n    // override\r\n    this._configFileParameter = this.defineStringParameter({\r\n      parameterLongName: '--config',\r\n      parameterShortName: '-c',\r\n      argumentName: 'FILE',\r\n      description: `Use the specified ${ExtractorConfig.FILENAME} file path, rather than guessing its location`\r\n    });\r\n\r\n    this._localParameter = this.defineFlagParameter({\r\n      parameterLongName: '--local',\r\n      parameterShortName: '-l',\r\n      description:\r\n        'Indicates that API Extractor is running as part of a local build,' +\r\n        \" e.g. on a developer's machine. This disables certain validation that would\" +\r\n        ' normally be performed for a ship/production build. For example, the *.api.md' +\r\n        ' report file is automatically copied in a local build.'\r\n    });\r\n\r\n    this._verboseParameter = this.defineFlagParameter({\r\n      parameterLongName: '--verbose',\r\n      parameterShortName: '-v',\r\n      description: 'Show additional informational messages in the output.'\r\n    });\r\n\r\n    this._diagnosticsParameter = this.defineFlagParameter({\r\n      parameterLongName: '--diagnostics',\r\n      description:\r\n        'Show diagnostic messages used for troubleshooting problems with API Extractor.' +\r\n        '  This flag also enables the \"--verbose\" flag.'\r\n    });\r\n\r\n    this._typescriptCompilerFolder = this.defineStringParameter({\r\n      parameterLongName: '--typescript-compiler-folder',\r\n      argumentName: 'PATH',\r\n      description:\r\n        'API Extractor uses its own TypeScript compiler engine to analyze your project.  If your project' +\r\n        ' is built with a significantly different TypeScript version, sometimes API Extractor may report compilation' +\r\n        ' errors due to differences in the system typings (e.g. lib.dom.d.ts).  You can use the' +\r\n        ' \"--typescriptCompilerFolder\" option to specify the folder path where you installed the TypeScript package,' +\r\n        \" and API Extractor's compiler will use those system typings instead.\"\r\n    });\r\n  }\r\n\r\n  protected async onExecute(): Promise<void> {\r\n    // override\r\n    const lookup: PackageJsonLookup = new PackageJsonLookup();\r\n    let configFilename: string;\r\n\r\n    let typescriptCompilerFolder: string | undefined = this._typescriptCompilerFolder.value;\r\n    if (typescriptCompilerFolder) {\r\n      typescriptCompilerFolder = path.normalize(typescriptCompilerFolder);\r\n\r\n      if (FileSystem.exists(typescriptCompilerFolder)) {\r\n        typescriptCompilerFolder = lookup.tryGetPackageFolderFor(typescriptCompilerFolder);\r\n        const typescriptCompilerPackageJson: IPackageJson | undefined = typescriptCompilerFolder\r\n          ? lookup.tryLoadPackageJsonFor(typescriptCompilerFolder)\r\n          : undefined;\r\n        if (!typescriptCompilerPackageJson) {\r\n          throw new Error(\r\n            `The path specified in the ${this._typescriptCompilerFolder.longName} parameter is not a package.`\r\n          );\r\n        } else if (typescriptCompilerPackageJson.name !== 'typescript') {\r\n          throw new Error(\r\n            `The path specified in the ${this._typescriptCompilerFolder.longName} parameter is not a TypeScript` +\r\n              ' compiler package.'\r\n          );\r\n        }\r\n      } else {\r\n        throw new Error(\r\n          `The path specified in the ${this._typescriptCompilerFolder.longName} parameter does not exist.`\r\n        );\r\n      }\r\n    }\r\n\r\n    let extractorConfig: ExtractorConfig;\r\n\r\n    if (this._configFileParameter.value) {\r\n      configFilename = path.normalize(this._configFileParameter.value);\r\n      if (!FileSystem.exists(configFilename)) {\r\n        throw new Error('Config file not found: ' + this._configFileParameter.value);\r\n      }\r\n\r\n      extractorConfig = ExtractorConfig.loadFileAndPrepare(configFilename);\r\n    } else {\r\n      const prepareOptions: IExtractorConfigPrepareOptions | undefined = ExtractorConfig.tryLoadForFolder({\r\n        startingFolder: '.'\r\n      });\r\n\r\n      if (!prepareOptions || !prepareOptions.configObjectFullPath) {\r\n        throw new Error(`Unable to find an ${ExtractorConfig.FILENAME} file`);\r\n      }\r\n\r\n      const configObjectShortPath: string = Path.formatConcisely({\r\n        pathToConvert: prepareOptions.configObjectFullPath,\r\n        baseFolder: process.cwd()\r\n      });\r\n      console.log(`Using configuration from ${configObjectShortPath}`);\r\n\r\n      extractorConfig = ExtractorConfig.prepare(prepareOptions);\r\n    }\r\n\r\n    const extractorResult: ExtractorResult = Extractor.invoke(extractorConfig, {\r\n      localBuild: this._localParameter.value,\r\n      showVerboseMessages: this._verboseParameter.value,\r\n      showDiagnostics: this._diagnosticsParameter.value,\r\n      typescriptCompilerFolder: typescriptCompilerFolder\r\n    });\r\n\r\n    if (extractorResult.succeeded) {\r\n      console.log(os.EOL + 'API Extractor completed successfully');\r\n    } else {\r\n      process.exitCode = 1;\r\n\r\n      if (extractorResult.errorCount > 0) {\r\n        console.log(os.EOL + colors.red('API Extractor completed with errors'));\r\n      } else {\r\n        console.log(os.EOL + colors.yellow('API Extractor completed with warnings'));\r\n      }\r\n    }\r\n  }\r\n}\r\n"]}