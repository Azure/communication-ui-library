{"version":3,"file":"AstDeclaration.js","sourceRoot":"","sources":["../../src/analyzer/AstDeclaration.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as ts from 'typescript';\r\nimport { AstSymbol } from './AstSymbol';\r\nimport { Span } from './Span';\r\nimport { InternalError } from '@rushstack/node-core-library';\r\nimport { AstEntity } from './AstSymbolTable';\r\n\r\n/**\r\n * Constructor options for AstDeclaration\r\n */\r\nexport interface IAstDeclarationOptions {\r\n  readonly declaration: ts.Declaration;\r\n  readonly astSymbol: AstSymbol;\r\n  readonly parent: AstDeclaration | undefined;\r\n}\r\n\r\n/**\r\n * The AstDeclaration and AstSymbol classes are API Extractor's equivalent of the compiler's\r\n * ts.Declaration and ts.Symbol objects.  They are created by the `AstSymbolTable` class.\r\n *\r\n * @remarks\r\n * The AstDeclaration represents one or more syntax components of a symbol.  Usually there is\r\n * only one AstDeclaration per AstSymbol, but certain TypeScript constructs can have multiple\r\n * declarations (e.g. overloaded functions, merged declarations, etc.).\r\n *\r\n * Because of this, the `AstDeclaration` manages the parent/child nesting hierarchy (e.g. with\r\n * declaration merging, each declaration has its own children) and becomes the main focus\r\n * of analyzing AEDoc and emitting *.d.ts files.\r\n *\r\n * The AstDeclarations correspond to items from the compiler's ts.Node hierarchy, but\r\n * omitting/skipping any nodes that don't match the AstDeclaration.isSupportedSyntaxKind()\r\n * criteria.  This simplification makes the other API Extractor stages easier to implement.\r\n */\r\nexport class AstDeclaration {\r\n  public readonly declaration: ts.Declaration;\r\n\r\n  public readonly astSymbol: AstSymbol;\r\n\r\n  /**\r\n   * The parent, if this object is nested inside another AstDeclaration.\r\n   */\r\n  public readonly parent: AstDeclaration | undefined;\r\n\r\n  /**\r\n   * A bit set of TypeScript modifiers such as \"private\", \"protected\", etc.\r\n   */\r\n  public readonly modifierFlags: ts.ModifierFlags;\r\n\r\n  /**\r\n   * Additional information that is calculated later by the `Collector`.  The actual type is `DeclarationMetadata`,\r\n   * but we declare it as `unknown` because consumers must obtain this object by calling\r\n   * `Collector.fetchDeclarationMetadata()`.\r\n   */\r\n  public declarationMetadata: unknown;\r\n\r\n  /**\r\n   * Additional information that is calculated later by the `Collector`.  The actual type is `ApiItemMetadata`,\r\n   * but we declare it as `unknown` because consumers must obtain this object by calling\r\n   * `Collector.fetchApiItemMetadata()`.\r\n   */\r\n  public apiItemMetadata: unknown;\r\n\r\n  // NOTE: This array becomes immutable after astSymbol.analyze() sets astSymbol.analyzed=true\r\n  private readonly _analyzedChildren: AstDeclaration[] = [];\r\n\r\n  private readonly _analyzedReferencedAstEntitiesSet: Set<AstEntity> = new Set<AstEntity>();\r\n\r\n  // Reverse lookup used by findChildrenWithName()\r\n  private _childrenByName: Map<string, AstDeclaration[]> | undefined = undefined;\r\n\r\n  public constructor(options: IAstDeclarationOptions) {\r\n    this.declaration = options.declaration;\r\n    this.astSymbol = options.astSymbol;\r\n    this.parent = options.parent;\r\n\r\n    this.astSymbol._notifyDeclarationAttach(this);\r\n\r\n    if (this.parent) {\r\n      this.parent._notifyChildAttach(this);\r\n    }\r\n\r\n    this.modifierFlags = ts.getCombinedModifierFlags(this.declaration);\r\n\r\n    // Check for ECMAScript private fields, for example:\r\n    //\r\n    //    class Person { #name: string; }\r\n    //\r\n    const declarationName: ts.DeclarationName | undefined = ts.getNameOfDeclaration(this.declaration);\r\n    if (declarationName) {\r\n      if (ts.isPrivateIdentifier(declarationName)) {\r\n        // eslint-disable-next-line no-bitwise\r\n        this.modifierFlags |= ts.ModifierFlags.Private;\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns the children for this AstDeclaration.\r\n   * @remarks\r\n   * The collection will be empty until AstSymbol.analyzed is true.\r\n   */\r\n  public get children(): ReadonlyArray<AstDeclaration> {\r\n    return this.astSymbol.analyzed ? this._analyzedChildren : [];\r\n  }\r\n\r\n  /**\r\n   * Returns the AstEntity objects referenced by this node.\r\n   * @remarks\r\n   * NOTE: The collection will be empty until AstSymbol.analyzed is true.\r\n   *\r\n   * Since we assume references are always collected by a traversal starting at the\r\n   * root of the nesting declarations, this array omits the following items because they\r\n   * would be redundant:\r\n   * - symbols corresponding to parents of this declaration (e.g. a method that returns its own class)\r\n   * - symbols already listed in the referencedAstSymbols property for parents of this declaration\r\n   *   (e.g. a method that returns its own class's base class)\r\n   * - symbols that are referenced only by nested children of this declaration\r\n   *   (e.g. if a method returns an enum, this doesn't imply that the method's class references that enum)\r\n   */\r\n  public get referencedAstEntities(): ReadonlyArray<AstEntity> {\r\n    return this.astSymbol.analyzed ? [...this._analyzedReferencedAstEntitiesSet] : [];\r\n  }\r\n\r\n  /**\r\n   * This is an internal callback used when the AstSymbolTable attaches a new\r\n   * child AstDeclaration to this object.\r\n   * @internal\r\n   */\r\n  public _notifyChildAttach(child: AstDeclaration): void {\r\n    if (child.parent !== this) {\r\n      throw new InternalError('Invalid call to notifyChildAttach()');\r\n    }\r\n\r\n    if (this.astSymbol.analyzed) {\r\n      throw new InternalError('_notifyChildAttach() called after analysis is already complete');\r\n    }\r\n\r\n    this._analyzedChildren.push(child);\r\n  }\r\n\r\n  /**\r\n   * Returns a diagnostic dump of the tree, which reports the hierarchy of\r\n   * AstDefinition objects.\r\n   */\r\n  public getDump(indent: string = ''): string {\r\n    const declarationKind: string = ts.SyntaxKind[this.declaration.kind];\r\n    let result: string = indent + `+ ${this.astSymbol.localName} (${declarationKind})`;\r\n    if (this.astSymbol.nominalAnalysis) {\r\n      result += ' (nominal)';\r\n    }\r\n    result += '\\n';\r\n\r\n    for (const referencedAstEntity of this._analyzedReferencedAstEntitiesSet.values()) {\r\n      result += indent + `  ref: ${referencedAstEntity.localName}\\n`;\r\n    }\r\n\r\n    for (const child of this.children) {\r\n      result += child.getDump(indent + '  ');\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Returns a diagnostic dump using Span.getDump(), which reports the detailed\r\n   * compiler structure.\r\n   */\r\n  public getSpanDump(indent: string = ''): string {\r\n    const span: Span = new Span(this.declaration);\r\n    return span.getDump(indent);\r\n  }\r\n\r\n  /**\r\n   * This is an internal callback used when AstSymbolTable.analyze() discovers a new\r\n   * type reference associated with this declaration.\r\n   * @internal\r\n   */\r\n  public _notifyReferencedAstEntity(referencedAstEntity: AstEntity): void {\r\n    if (this.astSymbol.analyzed) {\r\n      throw new InternalError('_notifyReferencedAstEntity() called after analysis is already complete');\r\n    }\r\n\r\n    for (let current: AstDeclaration | undefined = this; current; current = current.parent) {\r\n      // Don't add references to symbols that are already referenced by a parent\r\n      if (current._analyzedReferencedAstEntitiesSet.has(referencedAstEntity)) {\r\n        return;\r\n      }\r\n      // Don't add the symbols of parents either\r\n      if (referencedAstEntity === current.astSymbol) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    this._analyzedReferencedAstEntitiesSet.add(referencedAstEntity);\r\n  }\r\n\r\n  /**\r\n   * Visits all the current declaration and all children recursively in a depth-first traversal,\r\n   * and performs the specified action for each one.\r\n   */\r\n  public forEachDeclarationRecursive(action: (astDeclaration: AstDeclaration) => void): void {\r\n    action(this);\r\n    for (const child of this.children) {\r\n      child.forEachDeclarationRecursive(action);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns the list of child declarations whose `AstSymbol.localName` matches the provided `name`.\r\n   *\r\n   * @remarks\r\n   * This is an efficient O(1) lookup.\r\n   */\r\n  public findChildrenWithName(name: string): ReadonlyArray<AstDeclaration> {\r\n    // The children property returns:\r\n    //\r\n    //    return this.astSymbol.analyzed ? this._analyzedChildren : [];\r\n    //\r\n    if (!this.astSymbol.analyzed || this._analyzedChildren.length === 0) {\r\n      return [];\r\n    }\r\n\r\n    if (this._childrenByName === undefined) {\r\n      // Build the lookup table\r\n      const childrenByName: Map<string, AstDeclaration[]> = new Map<string, AstDeclaration[]>();\r\n\r\n      for (const child of this._analyzedChildren) {\r\n        const childName: string = child.astSymbol.localName;\r\n        let array: AstDeclaration[] | undefined = childrenByName.get(childName);\r\n        if (array === undefined) {\r\n          array = [];\r\n          childrenByName.set(childName, array);\r\n        }\r\n        array.push(child);\r\n      }\r\n      this._childrenByName = childrenByName;\r\n    }\r\n\r\n    return this._childrenByName.get(name) || [];\r\n  }\r\n\r\n  /**\r\n   * This function determines which ts.Node kinds will generate an AstDeclaration.\r\n   * These correspond to the definitions that we can add AEDoc to.\r\n   */\r\n  public static isSupportedSyntaxKind(kind: ts.SyntaxKind): boolean {\r\n    // (alphabetical order)\r\n    switch (kind) {\r\n      case ts.SyntaxKind.CallSignature:\r\n      case ts.SyntaxKind.ClassDeclaration:\r\n      case ts.SyntaxKind.ConstructSignature: // Example: \"new(x: number): IMyClass\"\r\n      case ts.SyntaxKind.Constructor: // Example: \"constructor(x: number)\"\r\n      case ts.SyntaxKind.EnumDeclaration:\r\n      case ts.SyntaxKind.EnumMember:\r\n      case ts.SyntaxKind.FunctionDeclaration: // Example: \"(x: number): number\"\r\n      case ts.SyntaxKind.GetAccessor:\r\n      case ts.SyntaxKind.SetAccessor:\r\n      case ts.SyntaxKind.IndexSignature: // Example: \"[key: string]: string\"\r\n      case ts.SyntaxKind.InterfaceDeclaration:\r\n      case ts.SyntaxKind.MethodDeclaration:\r\n      case ts.SyntaxKind.MethodSignature:\r\n      case ts.SyntaxKind.ModuleDeclaration: // Used for both \"module\" and \"namespace\" declarations\r\n      case ts.SyntaxKind.PropertyDeclaration:\r\n      case ts.SyntaxKind.PropertySignature:\r\n      case ts.SyntaxKind.TypeAliasDeclaration: // Example: \"type Shape = Circle | Square\"\r\n      case ts.SyntaxKind.VariableDeclaration:\r\n        return true;\r\n\r\n      // NOTE: Prior to TypeScript 3.7, in the emitted .d.ts files, the compiler would merge a GetAccessor/SetAccessor\r\n      // pair into a single PropertyDeclaration.\r\n\r\n      // NOTE: In contexts where a source file is treated as a module, we do create \"nominal analysis\"\r\n      // AstSymbol objects corresponding to a ts.SyntaxKind.SourceFile node.  However, a source file\r\n      // is NOT considered a nesting structure, and it does NOT act as a root for the declarations\r\n      // appearing in the file.  This is because the *.d.ts generator is in the business of rolling up\r\n      // source files, and thus wants to ignore them in general.\r\n    }\r\n\r\n    return false;\r\n  }\r\n}\r\n"]}