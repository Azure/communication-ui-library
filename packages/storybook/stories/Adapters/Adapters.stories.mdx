import { MessageBar } from '@fluentui/react';
import { Meta, Source } from '@storybook/addon-docs';
const CallAdapterExampleText = require('!!raw-loader!./snippets/CallAdapterExample.snippet.tsx').default;
const ChatAdapterExampleText = require('!!raw-loader!./snippets/ChatAdapterExample.snippet.tsx').default;

<Meta
  id="composite-adapters"
  title="Composites/Adapters"
  parameters={{ previewTabs: { canvas: { disable: true, hidden: true } } }}
/>

# Adapters for Composites

Composites deliver turn-key communication experiences for developers.
They make it easy for developers to add end-to-end communication experiences to their apps with only a couple lines of code.
To power Composites, the UI library provides `Adapters`, one for the calling composite [here](./?path=/docs/composites-call-basicexample--basic-example) and one for chat composite
[here](./?path=/docs/composites-chat-basicexample--basic-example).
These adapters make use of the stateful clients for calling and chat in conjunction with React Hooks like usePropsFor to provide developers a single interface to configure Composites.

## Setting Up Adapters

To setup the adapters, you will need to provide the adapter with key metadata required.
This includes most importantly an access token for your Azure Communication Services resource and context information for the call or chat thread you want to join.
To create the adapters we will use the `createAzureCommunicationCallAdapter` and `createAzureCommunicationChatAdapter` helper methods.
These methods are asynchronous so we will use `useEffect` to create them.

### Call Adapter

To initialize the call adapter, you will be required to provide a call locator with the information of the group or meeting you are trying to join.
Group Id for Azure Communication Services take the shape of GUID generated by the developer to identify a call inside their tenant.
Teams Meeting information can be acquired through [Microsoft Graph](https://docs.microsoft.com/graph/overview).

<Source code={CallAdapterExampleText} />

<MessageBar>Note: The `displayName` in Call Composite can be a maximum of 256 characters.</MessageBar>

### Chat Adapter

To initialize the chat adapter, you will be required to provide an endpoint url for the Azure Communication Services resource on [Azure Portal](https://portal.azure.com).
In addition, you will need to provide a thread Id. Thread Id is provisioned from the Azure Communication Services by creating a new thread or adding the user to an existing thread.
For more information on thread Id, see our [documentation](https://docs.microsoft.com/azure/communication-services/concepts/chat/concepts).

<Source code={ChatAdapterExampleText} />

## Using Adapters

Once initialized, adapters can be used to initialize Composites as well as to pragmatically take actions on the call or chat experience.

### Initializing Composites with Adapters

With the initialized adapters, we can now hook them into the calling and chat composites.

```typescript

import { CallComposite, ChatComposite} from '@azure/communication-react';

<CallComposite adapter={callAdapter} />

<ChatComposite adapter={chatAdapter} />

```

### Accessing Adapter Contents

The adapters provide developers access to state, actions and events related to the underlying chat and calling SDKs.
Below are some examples that might be helpful, but additional methods are available.

#### Call Adapter Examples

```typescript

//Access state and state changes, including CallClient and UI
callAdapter.onStateChange((state) => {
  console.log(state.userId)
})
callAdapter.getState().userId
callAdapter.getState().call
callAdapter.getState().devices

//Access actions for the call
callAdapter.mute()
callAdapter.queryMicrophones()
callAdapter.startCamera()

//Call events
callAdapter.on('participantsJoined, (event)=>{
  event.joined.forEach((participant) => {
    console.log(participant.displayName);
  });
})
callAdapter.on('callEnded, (event) => {
  console.log(event.callId);
})
callAdapter.on('error', (e: Error) => {
  console.log(JSON.stringify(e))
})

```

#### Chat Adapter Examples

```typescript

//Access state and state changes, including ChatClient and UI
chatAdapter.onStateChange((state) => {
  console.log(state.userId)
})
chatAdapter.getState().thread
chatAdapter.getState().userId

//Access actions for the chat
chatAdapter.sendMessage()
chatAdapter.removeParticipants()
chatAdapter.setTopic()

//Chat events
chatAdapter.on('messageReceived, (event) => {
  console.log(event.message.content?.message);
})
chatAdapter.on('messageSent, (event) => {
  console.log(event.message.content?.message);
})
chatAdapter.on('topicChanged', (event) => {
  console.log(event.topic);
})

```

## Interfaces

### CallAdapter

| Method                    | Details                                                                                                                                                                                                                                                                                                              | Signature                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **`onStateChange`**       | Subscribes the handler to stateChanged events.                                                                                                                                                                                                                                                                       | `(handler: (state: ` [`CallAdapterState`](#calladapterstate) `) => void) => void`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **`offStateChange`**      | Unsubscribes the handler to stateChanged events.                                                                                                                                                                                                                                                                     | `(handler: (state: ` [`CallAdapterState`](#calladapterstate) `) => void) => void`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| **`getState`**            | Get the current State.                                                                                                                                                                                                                                                                                               | `() => ` [`CallAdapterState`](#calladapterstate)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **`dispose`**             | Dispose of the Composite.                                                                                                                                                                                                                                                                                            | `() => void`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **`joinCall`**            | Join the call with microphone initially on/off.                                                                                                                                                                                                                                                                      | `(microphoneOn?: boolean ) => Call ` \| ` undefined` <br /><br />`microphoneOn`: Join call with microphone initially enabled.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **`leaveCall`**           | Leave the call.                                                                                                                                                                                                                                                                                                      | `(forEveryone?: boolean) => Promise<void>` <br /><br />`forEveryone`: Whether to remove all participants when leaving                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **`startCamera`**         | Start the camera This method will start rendering a local camera view when the call is not active.                                                                                                                                                                                                                   | `(options?: ` [`VideoStreamOptions`](https://docs.microsoft.com/en-us/javascript/api/@azure/communication-react/videostreamoptions)` ) => Promise<void>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **`stopCamera`**          | Stop the camera This method will stop rendering a local camera view when the call is not active.                                                                                                                                                                                                                     | `() => Promise<void>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **`mute`**                | Mute the current user during the call or disable microphone locally.                                                                                                                                                                                                                                                 | `() => Promise<void>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **`unmute`**              | Unmute the current user during the call or enable microphone locally.                                                                                                                                                                                                                                                | `() => Promise<void>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **`startCall`**           | Start the call.                                                                                                                                                                                                                                                                                                      | `(participants: string[]) => Call ` \| ` undefined` <br /><br />`participants`: Array of participantIDs to join                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| **`startScreenShare`**    | Start sharing the screen during a call.                                                                                                                                                                                                                                                                              | `() => Promise<void>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **`stopScreenShare`**     | Stop sharing the screen.                                                                                                                                                                                                                                                                                             | `() => Promise<void>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **`removeParticipant`**   | Remove a participant from the call.                                                                                                                                                                                                                                                                                  | `(userId: string) => Promise<void>` <br /><br />`userId`: Id of the participant to be removed                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **`createStreamView`**    | Create the html view for a stream.                                                                                                                                                                                                                                                                                   | `(remoteUserId?: string, options?: ` [`VideoStreamOptions`](https://docs.microsoft.com/en-us/javascript/api/@azure/communication-react/videostreamoptions)`) => Promise<void>` <br /><br />`remoteUserId`: Id of the participant to render. Leave this `undefined` to create the local camera view. <br /><br />`options`: Options to control how video streams are rendered.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **`disposeStreamView`**   | Dispose the html view for a stream.                                                                                                                                                                                                                                                                                  | `(remoteUserId?: string, options?: ` [`VideoStreamOptions`](https://docs.microsoft.com/en-us/javascript/api/@azure/communication-react/videostreamoptions)`) => Promise<void>` <br /><br />`remoteUserId`: Id of the participant to render. Leave this `undefined` to dispose the local camera view. <br /><br />`options`: Options to control how video streams are rendered.                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| **`askDevicePermission`** | Ask for permissions of devices.                                                                                                                                                                                                                                                                                      | `(constrain: `[`PermissionConstraints`](https://docs.microsoft.com/en-us/javascript/api/azure-communication-services/@azure/communication-calling/permissionconstraints)`) => Promise<void>` <br /><br />Constrain what permissions are being asked for.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **`queryCameras`**        | Query for available camera devices.                                                                                                                                                                                                                                                                                  | `() => Promise<`[`VideoDeviceInfo`](https://docs.microsoft.com/en-us/javascript/api/azure-communication-services/@azure/communication-calling/videodeviceinfo)`[]>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **`queryMicrophones`**    | Query for available microphone devices.                                                                                                                                                                                                                                                                              | `() => Promise<`[`AudioDeviceInfo`](https://docs.microsoft.com/en-us/javascript/api/azure-communication-services/@azure/communication-calling/audiodeviceinfo)`[]>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **`querySpeakers`**       | Query for available microphone devices.                                                                                                                                                                                                                                                                              | `() => Promise<`[`AudioDeviceInfo`](https://docs.microsoft.com/en-us/javascript/api/azure-communication-services/@azure/communication-calling/audiodeviceinfo)`[]>`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **`setCamera`**           | Set the camera to use in the call.                                                                                                                                                                                                                                                                                   | `(sourceInfo: `[`VideoDeviceInfo`](https://docs.microsoft.com/en-us/javascript/api/azure-communication-services/@azure/communication-calling/videodeviceinfo)`, options?: ` [`VideoStreamOptions`](https://docs.microsoft.com/en-us/javascript/api/@azure/communication-react/videostreamoptions)`) => Promise<void>` <br /><br />`sourceInfo`: Camera device to choose, pick one returned by `queryCameras`. `options`: Options to control how the camera stream is rendered.                                                                                                                                                                                                                                                                                                                                                                               |
| **`setMicrophone`**       | Set the microphone to use in the call.                                                                                                                                                                                                                                                                               | `(sourceInfo: `[`AudioDeviceInfo`](https://docs.microsoft.com/en-us/javascript/api/azure-communication-services/@azure/communication-calling/audiodeviceinfo)`) => Promise<void>` <br /><br />`sourceInfo`: Camera device to choose, pick one returned by `queryMicrophones`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **`setSpeaker`**          | Set the speaker to use in the call.                                                                                                                                                                                                                                                                                  | `(sourceInfo: `[`AudioDeviceInfo`](https://docs.microsoft.com/en-us/javascript/api/azure-communication-services/@azure/communication-calling/audiodeviceinfo)`) => Promise<void>` <br /><br />`sourceInfo`: Camera device to choose, pick one returned by `querySpeakers`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **`on`**                  | Subscribe to event.<br /><br />Events:<br /> `participantsJoined` <br /> `participantsLeft` <br /> `isMutedChanged` <br /> `callIdChanged` <br /> `isLocalScreenSharingActiveChanged` <br /> `displayNameChanged` <br /> `isSpeakingChanged` <br /> `callEnded` <br /> `diagnosticChanged` <br /> `error` <br />     | `on(event: 'participantsJoined', listener: ParticipantsJoinedListener): void` <br /> `on(event: 'participantsLeft', listener: ParticipantsLeftListener): void` <br /> `on(event: 'isMutedChanged', listener: IsMutedChangedListener): void` <br /> `on(event: 'callIdChanged', listener: CallIdChangedListener): void` <br /> `on(event: 'isLocalScreenSharingActiveChanged', listener: IsLocalScreenSharingActiveChangedListener): void` <br /> `on(event: 'displayNameChanged', listener: DisplayNameChangedListener): void` <br /> `on(event: 'isSpeakingChanged', listener: IsSpeakingChangedListener): void` <br /> `on(event: 'callEnded', listener: CallEndedListener): void` <br /> `on(event: 'diagnosticChanged', listener: DiagnosticChangedEventListner): void` <br /> `on(event: 'error', listener: (e: AdapterError) => void): void`           |
| **`off`**                 | Unsubscribe from event.<br /><br />Events:<br /> `participantsJoined` <br /> `participantsLeft` <br /> `isMutedChanged` <br /> `callIdChanged` <br /> `isLocalScreenSharingActiveChanged` <br /> `displayNameChanged` <br /> `isSpeakingChanged` <br /> `callEnded` <br /> `diagnosticChanged` <br /> `error` <br /> | `off(event: 'participantsJoined', listener: ParticipantsJoinedListener): void` <br /> `off(event: 'participantsLeft', listener: ParticipantsLeftListener): void` <br /> `off(event: 'isMutedChanged', listener: IsMutedChangedListener): void` <br /> `off(event: 'callIdChanged', listener: CallIdChangedListener): void` <br /> `off(event: 'isLocalScreenSharingActiveChanged', listener: IsLocalScreenSharingActiveChangedListener): void` <br /> `off(event: 'displayNameChanged', listener: DisplayNameChangedListener): void` <br /> `off(event: 'isSpeakingChanged', listener: IsSpeakingChangedListener): void` <br /> `off(event: 'callEnded', listener: CallEndedListener): void` <br /> `off(event: 'diagnosticChanged', listener: DiagnosticChangedEventListner): void` <br /> `off(event: 'error', listener: (e: AdapterError) => void): void` |

### CallAdapterState

| Property                              | Type                                                                                                                                                  |
| ------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`isLocalPreviewMicrophoneEnabled`** | `boolean`                                                                                                                                             |
| **`page`**                            | `"accessDeniedTeamsMeeting"` \| `"call"` \| `"configuration"` \| `"joinCallFailedDueToNoNetwork"` \| `"leftCall"` \| `"lobby"` \| `"removedFromCall"` |
| **`userId`**                          | `CommunicationIdentifierKind`                                                                                                                         |
| **`displayName`**                     | `string`                                                                                                                                              |
| **`call`**                            | [`CallState`](https://docs.microsoft.com/en-us/javascript/api/@azure/communication-react/callstate)                                                   |
| **`devices`**                         | `DeviceManagerState`                                                                                                                                  |
| **`endedCall`**                       | `CallState`                                                                                                                                           |
| **`isTeamsCall`**                     | `boolean`                                                                                                                                             |
| **`latestErrors`**                    | `CallAdapterErrors` <br /><br />Latest error encountered for each operation performed via the adapter.                                                |

### ChatAdapter

| Method                         | Details                                                                                                           | Signature                                                                       |
| ------------------------------ | ----------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------- |
| **`fetchInitialData`**         | Fetch initial state for the Chat adapter. Performs the minimal fetch necessary for ChatComposite and API methods. | `() => Promise<void>`                                                           |
| **`onStateChange`**            | Subscribes the handler to stateChanged events.                                                                    | `(handler: (state: `[`ChatAdapterState`](#chatadapterstate)`) => void) => void` |
| **`offStateChange`**           | Unsubscribes the handler to stateChanged events.                                                                  | `(handler: (state: `[`ChatAdapterState`](#chatadapterstate)`) => void) => void` |
| **`getState`**                 | Get the current State                                                                                             | `() => `[`ChatAdapterState`](#chatadapterstate)                                 |
| **`dispose`**                  | Dispose of the Composite                                                                                          | `() => void`                                                                    |
| **`sendMessage`**              | Send a message in the thread.                                                                                     | `(content: string) => Promise<void>`                                            |
| **`sendReadReceipt`**          | Send a read receipt for a message.                                                                                | `(chatMessageId: string) => Promise<void>`                                      |
| **`sendTypingIndicator`**      | Send typing indicator in the thread.                                                                              | `() => Promise<void>`                                                           |
| **`removeParticipant`**        | Remove a participant in the thread.                                                                               | `(userId: string) => Promise<void>`                                             |
| **`setTopic`**                 | Set the topic for the thread.                                                                                     | `(topicName: string) => Promise<void>`                                          |
| **`updateMessage`**            | Update a message content.                                                                                         | `(messageId: string, content: string) => Promise<void>`                         |
| **`deleteMessage`**            | Delete a message in the thread.                                                                                   | `(messageId: string) => Promise<void>`                                          |
| **`loadPreviousChatMessages`** | Load more previous messages in the chat thread history.                                                           | `(messagesToLoad: number) => Promise<boolean>`                                  |

### ChatAdapterState

| Property           | Type                                                                                                                                     |
| ------------------ | ---------------------------------------------------------------------------------------------------------------------------------------- |
| **`error`**        | `Error`                                                                                                                                  |
| **`userId`**       | [`CommunicationIdentifierKind`](https://docs.microsoft.com/en-us/javascript/api/@azure/communication-common/communicationidentifierkind) |
| **`displayName`**  | `string`                                                                                                                                 |
| **`thread`**       | [`ChatThreadClientState`](https://docs.microsoft.com/en-us/javascript/api/@azure/communication-chat/chatthreadclient)                    |
| **`latestErrors`** | `ChatAdapterErrors` <br /><br />Latest error encountered for each operation performed via the adapter                                    |

## Functions

### createAzureCommunicationCallAdapter

```ts
async function createAzureCommunicationCallAdapter(args: AzureCommunicationCallAdapterArgs);
```

#### AzureCommunicationCallAdapterArgs

| Property          | Type                                                                                                                                                                                                                                                                                                               |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **`userId`**      | [`CommunicationUserIdentifier`](https://docs.microsoft.com/en-us/javascript/api/@azure/communication-common/communicationuseridentifier)                                                                                                                                                                           |
| **`displayName`** | `string` <br />_DisplayName has a limit of of 256 characters._                                                                                                                                                                                                                                                     |
| **`credential`**  | [`CommunicationTokenCredential`](https://docs.microsoft.com/en-us/javascript/api/@azure/communication-common/azurecommunicationtokencredential)                                                                                                                                                                    |
| **`locator`**     | [`GroupCallLocator`](https://docs.microsoft.com/en-us/javascript/api/azure-communication-services/@azure/communication-calling/groupcalllocator) \| [`TeamsMeetingLinkLocator`](https://docs.microsoft.com/en-us/javascript/api/azure-communication-services/@azure/communication-calling/teamsmeetinglinklocator) |

### createAzureCommunicationChatAdapter

```ts
async function createAzureCommunicationCallAdapter(args: AzureCommunicationChatAdapterArgs);
```

#### AzureCommunicationChatAdapterArgs

| Property          | Type                                                                                                                                            |
| ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| **`userId`**      | [`CommunicationUserIdentifier`](https://docs.microsoft.com/en-us/javascript/api/@azure/communication-common/communicationuseridentifier)        |
| **`displayName`** | `string` <br />_DisplayName has a limit of of 256 characters._                                                                                  |
| **`credential`**  | [`CommunicationTokenCredential`](https://docs.microsoft.com/en-us/javascript/api/@azure/communication-common/azurecommunicationtokencredential) |
| **`endpoint`**    | `string`                                                                                                                                        |
| **`threadId`**    | `string`                                                                                                                                        |
