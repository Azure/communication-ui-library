import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Stateful Client/Chat Introduction" />

# Introduction

The `Declarative Chat` is a stateful Chat library that allows you to use `@azure/communication-chat` in a stateful manner.
It provides a proxy layer built on top of the `@azure/communication-chat` and augments the `ChatClient` with a centralized state and a `onStateChange` event. This makes it easy to use with any declarative UI framework where state changes trigger view updates.

## Features

- Framework agnostic SDK that can be easily integrated into applications built using frameworks like React and Angular.
- Allows you to use custom data stores. For example, React Context, React State, Redux etc.
- API is identical to `@azure/communication-chat`. Can be used as a drop-in replacement.

## Installation

You can install the `@azure/acs-chat-declarative` library in your project by running the following command.
You will also need to install the `@azure/communication-common` library for generating `AzureCommunicationTokenCredential`.

```bash
# Install the pre-requisite `@azure/communication-chat` and `@azure/communication-common` library
npm i --save @azure/communication-chat @azure/communication-common

# Install the Private Preview `@azure/acs-chat-declarative` tarball
npm i --save ./{path to @azure/acs-chat-declarative tarball}
```

## Setup Client

```tsx
import { ChatClient } from '@azure/communication-chat';
import { chatClientDeclaratify } from '@azure/acs-chat-declarative';
import { AzureCommunicationTokenCredential } from "@azure/communication-common";

const endpointUrl = '<ENDPOINT>';
const userAccessToken = '<USER_ACCESS_TOKEN>';
const tokenCredential = new AzureCommunicationTokenCredential(userAccessToken);

const declarativeChatClient = chatClientDeclaratify(
  new ChatClient(endpointUrl, tokenCredential, { userId, displayName }
)

// You can then use the `declarativeChatClient` in the same way as a `ChatClient` with a slight variation.
// Details about the variation in usage are documented below under `Usage` section.
const chatThreadClient = await declarativeChatClient.createChatThread({});
```

## State Management

The Declarative Chat Client allows you to subscribe to state changes via an event listener.

```tsx
import { ChatClientState } from '@azure/acs-chat-declarative';

const onStateChange = (state: ChatClientState): void => {
  // The `state` variable contains new state whenever a change occurs.
};

// Subscribe to state changes
declarativeChatClient.onStateChange(onStateChange);

// Unsubscribe to state changes
declarativeChatClient.offStateChange(onStateChange);
```

## Usage

The API interface of declarative chat client is a superset of `@azure/communication-chat` with a slight variation in usage.

Although, calling a client method like `chatThreadClient.updateThread({ topic: 'newTopicName' })` will return some values; to view the changes triggered by such a client method, you need to subscribe to the `onStateChange` events as shown below.

```tsx
import { ChatClientState } from '@azure/acs-chat-declarative';

const threadId = 'CHAT_THREAD_ID';

const onStateChange = (state: ChatClientState): void => {
  console.log(state.threads.get(threadId)?.threadInfo?.topic);
};

// Subscribe to state changes
declarativeChatClient.onStateChange(onStateChange);

// Call client methods
// The topic update here will automatically trigger the console.log in the state change listener.
chatThreadClient.updateThread({ topic: 'newTopicName' });
```
