import { Meta, Source } from '@storybook/addon-docs';
import { DetailedBetaBanner } from './BetaBanners/DetailedBetaBanner';

import { TransferSnippet } from './snippets/transfer/Transfer.snippet';
import { TransferWithDialogPromptSnippet } from './snippets/transfer/TransferWithDialogPrompt.snippet';
import TransferSnippetText from '!!raw-loader!./snippets/transfer/Transfer.snippet.tsx';
import TransferWithDialogPromptSnippetText from '!!raw-loader!./snippets/transfer/TransferWithDialogPrompt.snippet.tsx';

<Meta
  id="transfer"
  title="Concepts/Transfer"
  parameters={{ previewTabs: { canvas: { disable: true, hidden: true } } }}
/>

# Transfer

<DetailedBetaBanner version={'1.5.2-beta.1'} />

During an active call, a participant can transfer another participant to another user or call. The transfer process
starts when one participant (the transferor) requests to transfer another participant (the transferee) to
another participant (the transfer target.) The transferee can accept or reject the request. If the request is
accepted, then the transfer target receives an incoming call from the transferee. If incoming call is accepted,
then the original call with the transferor ends.

In the current beta version, ACS users cannot request to transfer other participants yet but they can receive transfer
requests. Currently, only Teams users can request to transfer other participants.

A call with a Teams user can be made by using the `CallParticipantsLocator` as the locator
in the [AzureCommunicationCallAdapterArgs](./?path=/docs/composite-adapters--page#azurecommunicationcalladapterargs)
when using the
[useAzureCommunicationCallAdapter](./?path=/docs/composite-adapters--page#useazurecommunicationcalladapter)
function to create your [CallAdapter](path=/docs/composite-adapters--page#call-adapter).
In the current beta version, only one Teams user can be called.

The id of a Teams user can be obtained by using
[Microsoft Graph Explorer](https://developer.microsoft.com/en-us/graph/graph-explorer).
From there, sign in by clicking the circled button as shown below with a Microsoft account in the same tenant as the
Teams user you want to call.

<img style={{ width: 'auto', height: 'auto' }} src="images/graph-api-sign-in.png" />

Then create a GET request using v1.0 of the users API like shown below:

<img style={{ width: 'auto', height: 'auto' }} src="images/graph-api-get-user-id-api-request.png" />

The id should be in the API response as seen in the example below::

<img style={{ width: 'auto', height: 'auto' }} src="images/graph-api-id-highlighted.png" />

## Handling transfer requests

The [CallAdapter](path=/docs/composite-adapters--page#call-adapter) is able to receive `transferRequest` events and
allows you to handle these events by defining your own `TransferRequestedListener` callback. The following code snippet
shows an example of a `TransferRequestedListener` that accepts all `transferRequest` events.

<Source code={TransferSnippetText} />

The `afterCallAdapterCreate` callback in the above snippet can be modified to handle the transfer request such that
audio and video states from the original call are maintained after transfer.

```typescript
const afterCallAdapterCreate = useCallback(async (adapter: CallAdapter) => {
  adapter.on('transferRequested', (e) => {
    const videoSource = adapter.getState().call?.localVideoStreams?.[0]?.source;
    e.accept({
      audioOptions: { muted: adapter.getState().call?.isMuted },
      videoOptions: videoSource ? { localVideoStreams: [new LocalVideoStream(videoSource)] } : undefined
    });
  });
  return adapter;
}, []);
```

Here is another example of using a dialog to prompt the user to accept or reject transfer requests.

<Source code={TransferWithDialogPromptSnippetText} />

## Requesting transfers

ACS users cannot request transfers yet.
