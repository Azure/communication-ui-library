name: Deploy feature validation samples

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# cancel workflow when a newer version of the workflow is triggered on the same github ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: read-all

jobs:
  calling:
    name: Build and Deploy Calling App
    runs-on: ubuntu-latest
    permissions:
      # Needed for Azure login
      id-token: write
    environment: staging
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'
      - name: Install rush
        run: npm install -g @microsoft/rush@$(jq -r '.rushVersion' "rush.json")
      - name: Install dependencies
        run: rush install
      - name: Switch flavor for stable release build
        run: rush switch-flavor:stable
      - name: Build Communication-react
        run: rush build -t @azure/communication-react
      - name: Build Server
        run: rush build -o server
      - name: Build Calling
        run: rush build -o calling
      - name: Package Calling App
        run: rushx package
        working-directory: ./samples/Calling
      - name: Log in with Azure
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      - name: Deploy Calling
        uses: azure/webapps-deploy@v2
        with:
          app-name: acs-ui-dev-web-call-feature-validation
          package: ./samples/Calling/dist
