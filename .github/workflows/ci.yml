name: CI

on:
  # Postsubmit CI on main.
  push:
    branches: [main]
  # Presubmit CI on PRs to all branches.
  pull_request:
  # Allows you to run this workflow manually from the Actions tab.
  workflow_dispatch:

jobs:
  # composite_automation_test:
  #   name: Composite automation test
  #   runs-on: ubuntu-latest
  #   steps:
  #     # Checks-out your repository under $GITHUB_WORKSPACE so job can access it
  #     - uses: actions/checkout@v2
  #       with:
  #         fetch-depth: 0
  #     # Ensure node version is great enough
  #     - name: Use Node.js v14.x
  #       uses: actions/setup-node@v1
  #       with:
  #         node-version: '14.x'
  #     # Try get node_modules from cache
  #     - name: Restore node_modules from cache
  #       uses: actions/cache@v2
  #       with:
  #         path: common/temp/pnpm-store
  #         key: ${{ runner.os }}-${{ hashFiles('common/config/rush/pnpm-lock.yaml') }}
  #     # Install dependencies
  #     - name: Install rush
  #       run: npm install -g @microsoft/rush@5.47.0
  #     - name: Install dependencies
  #       run: rush install
  #     # Tests
  #     - name: Build Test
  #       run: |
  #         cd packages/react-composites
  #         rushx build:e2e:chat
  #         rushx build:e2e:call
  #         rushx build:e2e:meeting
  #     - name: Visual Regression Tests
  #       id: visualregressiontests
  #       run: |
  #         cd packages/react-composites
  #         rushx test:e2e:chat
  #         rushx test:e2e:call
  #         rushx test:e2e:meeting
  #         rushx test:e2e:chat
  #         rushx test:e2e:call
  #         rushx test:e2e:meeting
  #         rushx test:e2e:chat
  #         rushx test:e2e:call
  #         rushx test:e2e:meeting
  #         rushx test:e2e:chat
  #         rushx test:e2e:call
  #         rushx test:e2e:meeting
  #         rushx test:e2e:chat
  #         rushx test:e2e:call
  #         rushx test:e2e:meeting
  #       env:
  #         CONNECTION_STRING: ${{ secrets.CONNECTION_STRING }}
  #     - name: Upload snapshot diff
  #       if: ${{ always() && steps.visualregressiontests.outcome == 'failure' }}
  #       uses: actions/upload-artifact@v2
  #       with:
  #         name: snapshots
  #         path: packages/react-composites/test-results
  #     - name: Comment on PR
  #       if: ${{ github.event_name == 'pull_request' && always() && steps.visualregressiontests.outcome == 'failure' && !contains( github.event.pull_request.labels.*.name, 'ui change') }}
  #       uses: actions/github-script@v3
  #       with:
  #         github-token: ${{secrets.GITHUB_TOKEN}}
  #         script: |
  #           github.issues.createComment({
  #             issue_number: context.issue.number,
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             body: 'Failed to pass the UI Test. If this PR is for UI change and the error is snapshot mismatch, please add "ui change" label to the PR for updating the snapshot.'
  #           })

  update_composite_snapshot:
    name: Update composite snapshots
    runs-on: ubuntu-latest
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE so job can access it
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          # Use a machine account when checking out. This is to workaround the issue were GitHub
          # actions, when using the default account, cannot trigger other actions.
          # This machine account is only for this PAT, pwd was created and thrown away
          # If any update needed, create a new account, add access to the repo and generate a new PAT
          token: ${{ secrets.MACHINE_ACCOUNT_PAT }}
      # Ensure node version is great enough
      - name: Use Node.js v14.x
        uses: actions/setup-node@v1
        with:
          node-version: '14.x'
      # Try get node_modules from cache
      - name: Restore node_modules from cache
        uses: actions/cache@v2
        with:
          path: common/temp/pnpm-store
          key: ${{ runner.os }}-${{ hashFiles('common/config/rush/pnpm-lock.yaml') }}
      # Install dependencies
      - name: Install rush
        run: npm install -g @microsoft/rush@5.47.0
      - name: Install dependencies
        run: rush install
      - name: Build Test
        run: |
          cd packages/react-composites
          rushx build:e2e:chat
          rushx build:e2e:call
          rushx build:e2e:meeting
      - name: Update snapshot
        run: |
          cd packages/react-composites
          rushx test:e2e:chat:update
          rushx test:e2e:call:update
          rushx test:e2e:meeting:update
        env:
          CONNECTION_STRING: ${{ secrets.CONNECTION_STRING }}
      # Setup bot information for pushing new changes
      # Here we use the id from the github actions bot: https://api.github.com/users/better-informatics%5Bbot%5D
      - name: Setup bot git information
        run: |
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
      # Commit changes to snapshot files.
      - name: Commit new snapshots
        run: >
          git diff --exit-code --quiet -- packages/react-composites/tests || 
          (git add packages/react-composites/tests && 
          git commit -m 'Updating composite automation snapshots' && 
          git push origin HEAD:${{ github.head_ref }})
