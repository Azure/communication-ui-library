name: Manual Alpha Package Release

on:
  # Allows running workflow manually from the GitHub Actions tab
  workflow_dispatch:

# cancel workflow when a newer version of the workflow is triggered on the same github ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: Build and publish alpha package
    environment:
      name: npm-alpha
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      # Login via OIDC to permit uploading to azure blob store
      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.NPM_DEPLOY_AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.NPM_DEPLOY_AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.NPM_DEPLOY_AZURE_SUBSCRIPTION_ID }}

      # Get access token to trigger the release pipeline
      #
      # Ideally we would use `az pipelines release create` CLI, but it does not support release variables: https://github.com/Azure/azure-cli-extensions/issues/953
      # Instead, we use the az CLI to generate a PAT and then use that to trigger the release pipeline
      #
      # NOTES:
      #   - 590cfd2a-581c-4dcb-a12e-6568ce786175 is the GUID of the Azure Partner Pipelines ADO project
      #   - 499b84ac-1321-427f-aa17-267ca6975798 is generic GUID of Azure DevOps resource
      - name: Get Azure DevOps Access Token
        id: az-devops-access-token
        run: |
          az extension add --name azure-devops
          az devops configure --defaults organization=https://dev.azure.com/azure-sdk project=590cfd2a-581c-4dcb-a12e-6568ce786175
          echo "token=$(az account get-access-token --resource 499b84ac-1321-427f-aa17-267ca6975798 --query accessToken -o tsv)" >> $GITHUB_OUTPUT

      - name: Trigger alpha package release pipeline
        uses: Azure/pipelines@v1.2
        with:
          azure-devops-project-url: 'https://dev.azure.com/azure-sdk/internal'
          azure-pipeline-name: 'azuresdkpartnerdrops to npm'
          azure-devops-token: ${{ steps.az-devops-access-token.outputs.token }}
          azure-pipeline-variables: '{"accessLevel": "public", "BlobPath": "azure-communication-services/react/npm/${{ steps.version.outputs.version }}", "registry": "https://registry.npmjs.org/", "skipDiff": "False", "tag": "dev"}'
