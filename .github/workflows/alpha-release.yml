name: Manual Alpha Package Release

on:
  # Allows running workflow manually from the GitHub Actions tab
  workflow_dispatch:

# cancel workflow when a newer version of the workflow is triggered on the same github ref
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: Build and publish alpha package
    environment:
      name: npm-alpha
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      # Login via OIDC to permit uploading to azure blob store
      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.NPM_DEPLOY_AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.NPM_DEPLOY_AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.NPM_DEPLOY_AZURE_SUBSCRIPTION_ID }}

      # Trigger azure-sdk partner release pipeline
      # 24728 is the definition id of the `azuresdkpartnerdrops to npm` pipeline
      - name: Trigger alpha package release pipeline
        run: |
          az extension add --name azure-devops
          az pipelines release create --definition-id 24728 --org https://dev.azure.com/azure-sdk --project internal --artifact-metadata-list accessLevel=public BlobPath=azure-communication-services/react/npm/err-for-testing registry=https://registry.npmjs.org/ skipDiff=False tag=dev

        # uses: Azure/pipelines@v1.2
        # with:
        #   azure-devops-project-url: 'https://dev.azure.com/azure-sdk/internal'
        #   azure-pipeline-name: 'azuresdkpartnerdrops to npm'
        #   azure-devops-token: '${{ secrets.AZURE_SDK_RELEASE_PIPELINE_DEVOPS_TOKEN }}'
        #   azure-pipeline-variables: '{"accessLevel": "public", "BlobPath": "azure-communication-services/react/npm/${{ steps.version.outputs.version }}", "registry": "https://registry.npmjs.org/", "skipDiff": "False", "tag": "dev"}'
