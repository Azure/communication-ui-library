# UI Tests

UI test are used to prevent visual regressions. When a PR is put up, the CI pipeline runs a series of UI tests and takes visual snapshots inside each test. Each snapshot is compared to the baseline snapshot to check for any changes. If there are changes the snapshots must be updated as part of the PR. UI tests use [Playwright](https://playwright.dev/docs/intro) to generate snapshots.

UI tests must only be updated as part of the CI pipeline, this is because the build agents may run on a different OS and have different graphics setup that your local machine (so there will be slight pixel differences between locally generated snapshots and ones generated by the CI pipeline).

## Updating UI tests in the CI pipeline

Add `ui-change` label to the PR. The CI pipeline will now automatically update all snapshots in your PR.

## Running UI Tests locally

Normally you do not have to run the UI tests locally, but for debugging CI failures it can be necessary. To run locally:

```sh
# This example will build calling react-composite tests.

# Ensure dependencies are up to date
rush update

# Navigate to packlet directory
cd packages/react-composites

# Build the e2e tests
rushx build:e2e:call

# Set a connection string environment variable
# Powershell Users
$env:CONNECTION_STRING = 'resource <connection string>'
# Bash Users must create a .env file inside `tests/browser` directory.
# Sample `tests/browser/.env` file:
CONNECTION_STRING=<resource connection String>

# Delete existing snapshots
rm -rf tests\\browser\\call\\**-snapshots

# Run tests
rushx test:e2e:call
```

Notice we had to delete the existing snapshots. These are snapshots generated by the CI pipeline and thus won't match locally generated snapshots due to difference in graphics card, OS etc. For subsequent local runs you do not need to delete the snapshots.

Running locally should give you a better picture of what is happening in your tests.

For subsequent runs, if you only changes .test.ts files you do not need to rebuild and can simply run:

```sh
rushx test:e2e:call
```

If you change any test app code or any code in the src/ dir (or in any other packages), you will need to again run:

```sh
rushx build:e2e:call
```

## Running UI Test Apps manually

If your tests are still failing you may want to run the web app that is used in the test manually. To do so:

```sh
# This example will build calling react-composite tests.

# Navigate to packlet directory
cd packages/react-composites

# Build the e2e tests
rushx build:e2e:call

# Set a connection string environment variable
$env:CONNECTION_STRING = '<connection string>' # This differs per development environment, this command is for powershell

# Navigate to the web app directory
cd tests\\browser\\call\\app

# Run the web app
node ./serve.js
```

This will start the web app, however the web app does require a URL with all the correct parameters (e.g. `?displayName=<name>&token=<token>..etc..`).

We have not listed the required params as they may change as further parameters are added. However to get the parameters you can:

* In a call composite test, mark the test as `.only` and inside the test console log the URL
* Run the tests `rushx test:e2e:call`
* Copy the URL from the test output.

### Known Playwright issues

If you are having issues with playwright detecting a browser platform try the following commands

```sh
# to install with dependancies
npx playwright install --with-deps

# to install without dependancies
npx playwright install

# to install specific browser
npx playwright install chrome
```
